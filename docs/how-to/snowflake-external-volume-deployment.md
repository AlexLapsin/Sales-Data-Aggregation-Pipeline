# Snowflake External Volume Deployment Guide

## Overview

This guide documents the two-phase deployment process required for Snowflake External Volumes due to a circular dependency between Snowflake-generated External IDs and AWS IAM role trust policies.

## The Problem

**Circular Dependency:**
1. AWS IAM role trust policy needs the External ID before creation
2. External ID is auto-generated by Snowflake when creating the External Volume
3. Therefore, IAM role must be updated after External Volume creation

**Root Cause:** As of Terraform provider `snowflakedb/snowflake v2.8.0`, the `storage_aws_external_id` parameter is **read-only (Computed)** and cannot be set manually. Snowflake auto-generates a unique External ID for each External Volume.

## Solution: Two-Phase Terraform Apply

### Phase 1: Create External Volume

This phase creates the External Volume with a Snowflake-generated External ID. The IAM role is created, but its trust policy may not yet match.

```bash
cd infrastructure/terraform
source ../../export_tf_vars.sh
terraform apply
```

**What happens:**
- ✅ S3 buckets created
- ✅ IAM role created with External ID from `.env`
- ✅ External Volume created (Snowflake generates new External ID)
- ⚠️ IAM role trust policy may be out of sync if `.env` has wrong value

### Phase 2: Sync External ID

#### Step 1: Extract Snowflake-Generated External ID

**Method A - Using Terraform Output (Recommended):**
```bash
cd infrastructure/terraform
terraform output -raw snowflake_external_id
```

**Method B - Query Terraform State:**
```bash
cd infrastructure/terraform
terraform state show 'module.snowflake[0].snowflake_external_volume.s3_silver_volume[0]' | grep 'storage_aws_external_id'
```

**Method C - Query Snowflake Directly:**
```sql
DESC EXTERNAL VOLUME S3_SILVER_VOLUME;
-- Look for STORAGE_AWS_EXTERNAL_ID in the output
```

#### Step 2: Update .env File

Copy the External ID from Step 1 and update your `.env` file:

```bash
# Replace the existing line:
SNOWFLAKE_EXTERNAL_ID="old-value"

# With the extracted value:
SNOWFLAKE_EXTERNAL_ID="AVC24342_SFCRole=XXX_YourActualExternalID"
```

**Important:** Keep the quotes and ensure the entire value is correct.

#### Step 3: Re-Apply Terraform

```bash
cd infrastructure/terraform
source ../../export_tf_vars.sh
terraform apply
```

**Expected output:**
```
Plan: 0 to add, 1 to change, 0 to destroy

# module.iam.aws_iam_role.snowflake_access_role will be updated in-place
~ resource "aws_iam_role" "snowflake_access_role" {
    ~ assume_role_policy = jsonencode({
        ~ Condition = {
            ~ StringEquals = {
                ~ "sts:ExternalId" = "old-value" -> "new-value"
              }
          }
      })
  }
```

This confirms the IAM role trust policy is being synced with the Snowflake External ID.

### Phase 3: Verify Configuration

Test that Snowflake can now assume the IAM role:

```bash
python deploy/snowflake/setup_delta_direct.py
```

**Expected output:**
```
✓ Connected to Snowflake
✓ External volume 'S3_SILVER_VOLUME' exists
✓ Role 'ANALYTICS_ROLE' exists
[1/3] Creating catalog integration 'DELTA_CATALOG'...
  [SUCCESS] Catalog integration 'DELTA_CATALOG' created
[2/3] Creating Iceberg table 'SALES_SILVER_EXTERNAL'...
  [SUCCESS] Iceberg table 'SALES_SILVER_EXTERNAL' created
```

**If you see IAM assume role errors**, the External ID is still mismatched. Verify `.env` matches the Terraform state exactly.

## Troubleshooting

### Error: "User is not authorized to perform: sts:AssumeRole"

**Symptoms:**
```
Error assuming AWS_ROLE:
User: arn:aws:iam::836071698500:user/h5b71000-s is not authorized to perform:
sts:AssumeRole on resource: arn:aws:iam::976404003846:role/sales-data-pipeline-SnowflakeAccessRole-dev
```

**Cause:** External ID mismatch between `.env` (used for IAM role trust policy) and Snowflake External Volume.

**Solution:**
1. Extract the actual External ID from Snowflake:
   ```bash
   cd infrastructure/terraform
   terraform output -raw snowflake_external_id
   ```

2. Compare with `.env`:
   ```bash
   grep SNOWFLAKE_EXTERNAL_ID .env
   ```

3. If they don't match exactly, update `.env` and re-apply Terraform (Phase 2).

### Error: "Snowflake external_id output not found"

**Cause:** Terraform output was added after initial deployment.

**Solution:**
```bash
cd infrastructure/terraform
source ../../export_tf_vars.sh
terraform refresh
terraform output -raw snowflake_external_id
```

### How to Verify Sync Status

Check if IAM role trust policy matches External Volume:

```bash
# Get External ID from Terraform state
cd infrastructure/terraform
EXT_ID=$(terraform output -raw snowflake_external_id)

# Get External ID from .env
ENV_ID=$(grep '^SNOWFLAKE_EXTERNAL_ID=' ../../.env | cut -d= -f2 | tr -d '"')

# Compare
if [ "$EXT_ID" = "$ENV_ID" ]; then
    echo "✓ External IDs match - in sync"
else
    echo "✗ External IDs mismatch:"
    echo "  Terraform: $EXT_ID"
    echo "  .env:      $ENV_ID"
    echo "  Action required: Update .env and run terraform apply"
fi
```

## Best Practices

### 1. Always Run Both Phases for Fresh Deployments

When deploying from scratch or recreating infrastructure:
```bash
# Phase 1
terraform apply

# Phase 2 (immediately after)
EXTERNAL_ID=$(terraform output -raw snowflake_external_id)
# Update .env with $EXTERNAL_ID
terraform apply
```

### 2. Document External ID Changes

If you ever need to recreate the External Volume (e.g., `terraform taint`), document the old and new External IDs for audit purposes.

### 3. Automate Phase 2 (Optional)

Create a post-apply script:
```bash
#!/bin/bash
# scripts/sync_external_id.sh
set -e

cd infrastructure/terraform
EXTERNAL_ID=$(terraform output -raw snowflake_external_id)

# Update .env
sed -i "s|^SNOWFLAKE_EXTERNAL_ID=.*|SNOWFLAKE_EXTERNAL_ID=\"$EXTERNAL_ID\"|" ../../.env

echo "✓ External ID synced to .env"
echo "Run 'terraform apply' to update IAM role"
```

### 4. CI/CD Integration

For automated deployments:
```yaml
# Example GitHub Actions workflow
- name: Terraform Apply Phase 1
  run: terraform apply -auto-approve

- name: Extract External ID
  id: extract_id
  run: |
    EXTERNAL_ID=$(terraform output -raw snowflake_external_id)
    echo "::set-output name=external_id::$EXTERNAL_ID"

- name: Update Environment
  run: |
    echo "SNOWFLAKE_EXTERNAL_ID=${{ steps.extract_id.outputs.external_id }}" >> .env

- name: Terraform Apply Phase 2
  run: terraform apply -auto-approve
```

## Future Improvements

### Terraform Provider Enhancement

GitHub Issue to Monitor:
- [#2624 - Allow configuring storage_aws_external_id for snowflake_storage_integration](https://github.com/snowflakedb/terraform-provider-snowflake/issues/2624)

If this feature is implemented for `snowflake_storage_integration`, a similar feature request should be filed for `snowflake_external_volume` to allow pre-defining the External ID.

### Ideal Future State

Once the provider supports custom External IDs:
```hcl
resource "snowflake_external_volume" "s3_silver_volume" {
  name = "S3_SILVER_VOLUME"

  storage_location {
    storage_aws_external_id = var.SNOWFLAKE_EXTERNAL_ID  # ← Set from .env
    # ... other config
  }
}
```

This would eliminate the two-phase process entirely.

## Quick Reference

| Command | Purpose |
|---------|---------|
| `terraform output -raw snowflake_external_id` | Get Snowflake-generated External ID |
| `grep SNOWFLAKE_EXTERNAL_ID .env` | Check External ID in .env |
| `terraform state show 'module.iam.aws_iam_role.snowflake_access_role'` | View IAM role trust policy |
| `python deploy/snowflake/setup_delta_direct.py` | Test External Volume access |

## Related Documentation

- [Deploy Infrastructure](./deploy-infrastructure.md) - Main deployment guide
- [Troubleshooting](./troubleshooting.md) - General troubleshooting
- [Configuration Reference](../reference/configuration.md) - Environment variables

## Changelog

- **2025-01-29**: Initial documentation of two-phase deployment process
- **2025-01-29**: Added Terraform output for automated External ID extraction
