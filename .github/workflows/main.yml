name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    name: Lint, Type-Check & Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/core.txt
          pip install black flake8 mypy pytest pytest-cov
          pip install PyYAML jsonschema psutil
          pip install boto3-stubs[s3] types-requests

      - name: Black (style check)
        run: black --check .

      - name: Flake8 (lint)
        run: flake8 .

      - name: MyPy (static types)
        run: |
          mypy src/bronze --ignore-missing-imports || true
          mypy src/spark/jobs --ignore-missing-imports || true
          mypy src/streaming --ignore-missing-imports || true

      - name: Run unit tests
        run: |
          pytest tests/bronze/ tests/silver/ -v --maxfail=3 --disable-warnings || true

      - name: Run validation scripts
        run: |
          python tools/validation/config_validator.py --help

  build-docker-etl:
    name: Build ETL Docker Image
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build ETL Docker image
        run: |
          docker build -f infrastructure/docker/etl/Dockerfile -t sales-etl:${{ github.sha }} .

      - name: Save ETL image to tarball
        run: |
          docker save sales-etl:${{ github.sha }} | gzip > sales-etl-${{ github.sha }}.tar.gz

      - name: Upload ETL Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sales-etl-image
          path: sales-etl-${{ github.sha }}.tar.gz

  build-docker-spark:
    name: Build Spark Docker Image
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build Spark Docker image
        run: |
          docker build -f infrastructure/docker/Dockerfile.spark -t sales-spark:${{ github.sha }} .

      - name: Save Spark image to tarball
        run: |
          docker save sales-spark:${{ github.sha }} | gzip > sales-spark-${{ github.sha }}.tar.gz

      - name: Upload Spark Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sales-spark-image
          path: sales-spark-${{ github.sha }}.tar.gz
