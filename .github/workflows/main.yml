name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    name: Lint, Type-Check & Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/core.txt
          pip install -r requirements/dev.txt
          pip install -r requirements/spark.txt
          pip install -r requirements/test.txt
          pip install PyYAML jsonschema psutil
          pip install boto3-stubs[s3] types-requests

      - name: Black (style check)
        run: black --check .

      - name: Flake8 (lint)
        run: flake8 .

      - name: MyPy (static types)
        run: |
          mypy src/bronze --ignore-missing-imports
          mypy src/spark/jobs --ignore-missing-imports
          mypy src/streaming --ignore-missing-imports
        continue-on-error: true

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short --cov=src --cov-report=term-missing --cov-report=xml -m "not requires_credentials and not requires_infrastructure"

      - name: Run Bronze layer tests
        run: |
          pytest tests/bronze/ -v --tb=short -m "not requires_credentials and not requires_infrastructure"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Run validation scripts
        run: |
          python tools/validation/config_validator.py --help

  build-docker-etl:
    name: Build ETL Docker Image
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ETL Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/etl/Dockerfile
          tags: sales-etl:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/sales-etl.tar

      - name: Upload ETL Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sales-etl-image
          path: /tmp/sales-etl.tar
          retention-days: 7

  build-docker-spark:
    name: Build Spark Docker Image
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Spark Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/Dockerfile.spark
          tags: sales-spark:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/sales-spark.tar

      - name: Upload Spark Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sales-spark-image
          path: /tmp/sales-spark.tar
          retention-days: 7
