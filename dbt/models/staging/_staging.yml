# models/staging/_staging.yml
# Tests and documentation for staging models

version: 2

models:
  - name: stg_sales_raw
    description: "Cleaned and standardized streaming sales data from Kafka"
    columns:
      - name: sales_raw_key
        description: "Surrogate key for each sales record"
        tests:
          - not_null
          - unique

      - name: order_id
        description: "Business key - unique order identifier"
        tests:
          - not_null
          - unique

      - name: store_id
        description: "Store identifier where sale occurred"
        tests:
          - not_null

      - name: product_id
        description: "Product identifier"
        tests:
          - not_null

      - name: quantity
        description: "Number of units sold"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 1000

      - name: unit_price
        description: "Price per unit"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0.01
              max_value: 10000.00

      - name: net_amount
        description: "Final transaction amount after discounts"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0.01

      - name: sale_date
        description: "Date when sale occurred"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: "'2020-01-01'"
              max_value: "current_date()"

      - name: data_quality_score
        description: "Data completeness score (0-100)"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 70
              max_value: 100

    # Table-level tests
    tests:
      - dbt_utils.expression_is_true:
          expression: "gross_amount = quantity * unit_price"
          config:
            severity: error

      - dbt_utils.expression_is_true:
          expression: "net_amount = gross_amount - discount_amount"
          config:
            severity: warn

  - name: stg_sales_batch
    description: "Cleaned and standardized batch sales data from CSV processing"
    columns:
      - name: sales_batch_key
        description: "Surrogate key for each batch sales record"
        tests:
          - not_null
          - unique

      - name: order_id
        description: "Business key - unique order identifier"
        tests:
          - not_null
          - unique

      - name: batch_id
        description: "Batch processing identifier"
        tests:
          - not_null

      - name: ship_date
        description: "Date when order was shipped"
        tests:
          - dbt_utils.expression_is_true:
              expression: "ship_date >= sale_date or ship_date is null"

      - name: customer_segment
        description: "Customer segment classification"
        tests:
          - accepted_values:
              values: ['CONSUMER', 'CORPORATE', 'HOME_OFFICE', 'UNKNOWN']

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - order_id
            - batch_id

  - name: stg_products
    description: "Cleaned product master data"
    columns:
      - name: product_raw_key
        description: "Surrogate key for product record"
        tests:
          - not_null
          - unique

      - name: product_id
        description: "Unique product identifier"
        tests:
          - not_null

      - name: product_name
        description: "Product name"
        tests:
          - not_null

      - name: unit_price
        description: "Selling price per unit"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0.01

      - name: profit_margin_pct
        description: "Profit margin percentage"
        tests:
          - dbt_utils.accepted_range:
              min_value: -1.0
              max_value: 1.0

    tests:
      - dbt_utils.expression_is_true:
          expression: "unit_price >= coalesce(unit_cost, 0)"
          config:
            severity: warn

  - name: stg_stores
    description: "Cleaned store master data"
    columns:
      - name: store_raw_key
        description: "Surrogate key for store record"
        tests:
          - not_null
          - unique

      - name: store_id
        description: "Unique store identifier"
        tests:
          - not_null

      - name: store_name
        description: "Store name"
        tests:
          - not_null

      - name: opening_date
        description: "Date when store opened"
        tests:
          - dbt_utils.accepted_range:
              min_value: "'1900-01-01'"
              max_value: "current_date()"
