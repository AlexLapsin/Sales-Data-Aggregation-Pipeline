# models/staging/_enhanced_staging_tests.yml
# Enhanced testing configuration using custom generic tests

version: 2

models:
  - name: stg_sales_raw
    description: "Enhanced testing for streaming sales staging data"
    tests:
      # Test overall data quality and business rules
      - dbt_utils.expression_is_true:
          expression: "count(*) > 0"
          config:
            severity: error
      - reasonable_cardinality:
          column_name: store_id
          min_distinct_count: 1
          max_distinct_count: 10000
      - business_day_freshness:
          timestamp_column: sale_timestamp
          max_age_business_days: 2
          config:
            severity: warn

    columns:
      - name: sales_raw_key
        tests:
          - not_null
          - unique
          - string_length:
              min_length: 32
              max_length: 32  # MD5 hash length

      - name: order_id
        tests:
          - not_null
          - unique
          - string_length:
              min_length: 5
              max_length: 50

      - name: store_id
        tests:
          - not_null
          - string_length:
              min_length: 1
              max_length: 20

      - name: product_id
        tests:
          - not_null
          - string_length:
              min_length: 1
              max_length: 50

      - name: quantity
        tests:
          - not_null
          - acceptable_range:
              min_value: 1
              max_value: 1000
              inclusive: true

      - name: unit_price
        tests:
          - not_null
          - acceptable_range:
              min_value: 0.01
              max_value: 10000.00
              inclusive: true

      - name: net_amount
        tests:
          - not_null
          - acceptable_range:
              min_value: 0.01
              max_value: 100000.00

      - name: discount_rate
        tests:
          - acceptable_range:
              min_value: 0.0
              max_value: 1.0
              inclusive: true

      - name: sale_date
        tests:
          - not_null
          - acceptable_range:
              min_value: "'2020-01-01'"
              max_value: "current_date()"

      - name: sale_hour
        tests:
          - acceptable_range:
              min_value: 0
              max_value: 23
              inclusive: true

      - name: data_quality_score
        tests:
          - not_null
          - acceptable_range:
              min_value: 70
              max_value: 100
              inclusive: true

      - name: payment_method
        tests:
          - accepted_values:
              values: ['CREDIT_CARD', 'DEBIT_CARD', 'CASH', 'DIGITAL_WALLET', 'CHECK', 'OTHER']
              config:
                severity: warn

      - name: store_location
        tests:
          - string_length:
              min_length: 3
              max_length: 200
              config:
                where: "store_location is not null"

  - name: stg_sales_batch
    description: "Enhanced testing for batch sales staging data"
    tests:
      - reasonable_cardinality:
          column_name: batch_id
          min_distinct_count: 1
          max_distinct_count: 1000

    columns:
      - name: sales_batch_key
        tests:
          - not_null
          - unique

      - name: order_id
        tests:
          - not_null
          - unique

      - name: batch_id
        tests:
          - not_null

      - name: ship_date
        tests:
          - mutually_exclusive_ranges:
              lower_bound_column: sale_date
              upper_bound_column: ship_date
              config:
                where: "ship_date is not null"

      - name: customer_segment
        tests:
          - accepted_values:
              values: ['CONSUMER', 'CORPORATE', 'HOME_OFFICE', 'UNKNOWN']

  - name: stg_products
    description: "Enhanced testing for product staging data"
    tests:
      - reasonable_cardinality:
          column_name: category
          min_distinct_count: 3
          max_distinct_count: 50

    columns:
      - name: product_raw_key
        tests:
          - not_null
          - unique

      - name: product_id
        tests:
          - not_null

      - name: product_name
        tests:
          - not_null
          - string_length:
              min_length: 2
              max_length: 200

      - name: unit_price
        tests:
          - not_null
          - acceptable_range:
              min_value: 0.01
              max_value: 50000.00

      - name: profit_margin_pct
        tests:
          - acceptable_range:
              min_value: -1.0
              max_value: 1.0
              config:
                severity: warn

      - name: category
        tests:
          - not_null
          - string_length:
              min_length: 2
              max_length: 50

  - name: stg_stores
    description: "Enhanced testing for store staging data"
    columns:
      - name: store_raw_key
        tests:
          - not_null
          - unique

      - name: store_id
        tests:
          - not_null

      - name: store_name
        tests:
          - not_null
          - string_length:
              min_length: 2
              max_length: 100

      - name: opening_date
        tests:
          - acceptable_range:
              min_value: "'1900-01-01'"
              max_value: "current_date()"

      - name: region
        tests:
          - reasonable_cardinality:
              min_distinct_count: 1
              max_distinct_count: 20
